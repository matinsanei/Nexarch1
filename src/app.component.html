
<div class="flex h-screen bg-zinc-950 text-zinc-200 font-['Vazirmatn'] overflow-hidden selection:bg-zinc-700 selection:text-white">
  
  <!-- SIDEBAR: Inputs & Controls -->
  <aside class="w-80 min-w-[320px] bg-zinc-900 border-l border-zinc-800 flex flex-col z-20 shadow-xl">
    <!-- Header -->
    <div class="p-6 border-b border-zinc-800">
      <h1 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m-1 4h1m5-4h1m-1 4h1m-1-8h1"/>
        </svg>
        <span>AI Architect</span>
      </h1>
    </div>

    <!-- Input Form -->
    <div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
      
      <!-- Input Mode Toggle -->
      @if (step() === 'input') {
        <div class="bg-zinc-950 p-1 rounded-lg flex text-xs font-medium border border-zinc-800">
          <button (click)="inputType.set('numeric')" 
                  [class]="inputType() === 'numeric' ? 'bg-zinc-800 text-white shadow' : 'text-zinc-500 hover:text-zinc-300'"
                  class="flex-1 py-2 rounded-md transition-all">ورود ابعاد</button>
          <button (click)="inputType.set('draw')" 
                  [class]="inputType() === 'draw' ? 'bg-zinc-800 text-white shadow' : 'text-zinc-500 hover:text-zinc-300'"
                  class="flex-1 py-2 rounded-md transition-all">ترسیم زمین</button>
        </div>
      }

      @if (step() === 'input') {
        <!-- Numeric Inputs -->
        @if (inputType() === 'numeric') {
          <div class="space-y-4 animate-in fade-in slide-in-from-left-4 duration-300">
            <h2 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">ابعاد زمین (متر)</h2>
            <div class="grid grid-cols-2 gap-3">
              <div class="space-y-1">
                <label class="text-xs text-zinc-400">عرض</label>
                <input type="number" [(ngModel)]="landWidth" class="w-full bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-sm text-white focus:border-zinc-600 focus:outline-none">
              </div>
              <div class="space-y-1">
                <label class="text-xs text-zinc-400">طول</label>
                <input type="number" [(ngModel)]="landDepth" class="w-full bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-sm text-white focus:border-zinc-600 focus:outline-none">
              </div>
            </div>
          </div>
        }

        <!-- Drawing Controls -->
        @if (inputType() === 'draw') {
          <div class="space-y-4 animate-in fade-in slide-in-from-right-4 duration-300">
            <h2 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">ابزار ترسیم</h2>
            <p class="text-[10px] text-zinc-400 leading-relaxed">
              روی صفحه شطرنجی روبرو کلیک کنید تا نقاط گوشه‌های زمین را مشخص کنید.
            </p>
            <div class="flex gap-2">
              <button (click)="undoPoint()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs py-2 rounded border border-zinc-700 transition-colors">
                بازگشت (Undo)
              </button>
              <button (click)="resetDrawing()" class="flex-1 bg-zinc-800 hover:bg-red-900/30 hover:text-red-400 text-zinc-300 text-xs py-2 rounded border border-zinc-700 transition-colors">
                پاک کردن
              </button>
            </div>
            
            @if (polygonPoints().length > 0) {
               <div class="bg-zinc-900/50 p-3 rounded border border-zinc-800">
                 <span class="text-xs text-zinc-500 block">تعداد نقاط: {{polygonPoints().length}}</span>
                 @if (isDrawingValid()) {
                   <span class="text-xs text-green-400 block mt-1">شکل بسته شد (آماده تحلیل)</span>
                 } @else {
                   <span class="text-xs text-yellow-500 block mt-1">حداقل ۳ نقطه لازم است</span>
                 }
               </div>
            }
          </div>
        }
      }

      <!-- Common: Neighbors -->
      @if (step() === 'input') {
        <div class="space-y-4 pt-4 border-t border-zinc-800">
          <h2 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">طبقات همسایگان</h2>
          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="text-xs text-zinc-400">غربی</label>
              <input type="number" [(ngModel)]="neighborWestFloors" class="w-full bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-sm text-white focus:border-zinc-600 focus:outline-none">
            </div>
            <div class="space-y-1">
              <label class="text-xs text-zinc-400">شرقی</label>
              <input type="number" [(ngModel)]="neighborEastFloors" class="w-full bg-zinc-950 border border-zinc-800 rounded px-3 py-2 text-sm text-white focus:border-zinc-600 focus:outline-none">
            </div>
          </div>
        </div>
      }

      <!-- Action Button -->
      @if (step() !== 'result') {
        <button (click)="analyzePlot()" 
                [disabled]="step() === 'loading' || (inputType() === 'draw' && !isDrawingValid())"
                class="w-full bg-white text-zinc-900 hover:bg-zinc-200 disabled:bg-zinc-700 disabled:text-zinc-500 font-medium py-2.5 rounded text-sm transition-all flex items-center justify-center gap-2 mt-4">
          @if (step() === 'loading') {
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>در حال پردازش...</span>
          } @else {
            <span>محاسبه و طراحی</span>
          }
        </button>
      } @else {
         <button (click)="startOver()" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-2.5 rounded text-sm transition-all mt-4 border border-zinc-700">
           طراحی جدید
         </button>
      }

      <!-- Error -->
      @if (errorMessage(); as error) {
        <div class="p-3 bg-red-900/20 border border-red-900/50 rounded text-xs text-red-400 leading-relaxed">
          {{ error }}
        </div>
      }

      <!-- Results Info -->
      @if (analysisResult(); as result) {
        <div class="pt-6 border-t border-zinc-800 space-y-4 animate-in fade-in duration-500">
          <h2 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">خلاصه تحلیل</h2>
          <div class="grid grid-cols-2 gap-2">
            <div class="bg-zinc-800/50 p-3 rounded border border-zinc-800">
              <span class="block text-[10px] text-zinc-500">تعداد طبقات</span>
              <span class="text-lg font-bold text-white">{{ result.buildingSummary.totalFloors }}</span>
            </div>
            <div class="bg-zinc-800/50 p-3 rounded border border-zinc-800">
              <span class="block text-[10px] text-zinc-500">واحد در طبقه</span>
              <span class="text-lg font-bold text-white">{{ result.buildingSummary.unitsPerFloor }}</span>
            </div>
            <!-- Show calculated dimensions if drawn -->
            @if (inputType() === 'draw') {
               <div class="col-span-2 bg-zinc-800/50 p-2 rounded border border-zinc-800 flex justify-between text-[10px] text-zinc-400">
                 <span>ابعاد محاسبه شده:</span>
                 <span>{{landWidth()}}m × {{landDepth()}}m</span>
               </div>
            }
          </div>
          <div class="text-xs text-zinc-400 leading-relaxed bg-zinc-900/50 p-3 rounded border border-zinc-800/50 max-h-40 overflow-y-auto custom-scrollbar">
            {{ result.buildingSummary.summary }}
          </div>
        </div>
      }
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 flex flex-col bg-zinc-950 relative">
    
    @if (step() === 'input' && inputType() === 'draw') {
      <!-- DRAWING CANVAS AREA -->
      <div class="flex-1 relative bg-[#101012] cursor-crosshair flex flex-col items-center justify-center">
         <div class="absolute top-4 bg-zinc-900/80 backdrop-blur px-4 py-2 rounded-full border border-zinc-800 text-zinc-400 text-xs pointer-events-none select-none z-10">
           برای ترسیم گوشه‌های زمین کلیک کنید
         </div>
         <!-- Canvas Container with fixed aspect for grid -->
         <div class="relative shadow-2xl border border-zinc-800 bg-zinc-900 w-[600px] h-[600px]">
            <canvas #drawCanvas 
                    width="600" height="600" 
                    (click)="onCanvasClick($event)"
                    class="w-full h-full block"></canvas>
         </div>
         <div class="mt-4 text-zinc-600 text-[10px]">هر خانه شبکه معادل ۱.۲۵ متر</div>
      </div>
    } @else if (analysisResult(); as result) {
      <!-- RESULT VIEW -->
      <div class="h-14 border-b border-zinc-800 flex items-center justify-between px-6 bg-zinc-950/80 backdrop-blur z-10">
        <div class="flex items-center gap-2">
          <span class="text-xs text-zinc-500 ml-2">طبقه:</span>
          @for (floor of result.floorPlans; track floor.level; let i = $index) {
            <button (click)="selectedFloor.set(i)" 
                    [class]="selectedFloor() === i ? 'bg-white text-zinc-900 border-white' : 'bg-zinc-900 text-zinc-400 border-zinc-700 hover:border-zinc-500'"
                    class="px-3 py-1 text-xs rounded border transition-colors">
              {{ floor.level === 0 ? 'همکف' : floor.level }}
            </button>
          }
        </div>

        <div class="flex bg-zinc-900 rounded p-1 border border-zinc-800">
          <button (click)="viewMode.set('2d')" [class.bg-zinc-700]="viewMode() === '2d'" [class.text-white]="viewMode() === '2d'" class="px-3 py-1 text-xs rounded transition-colors text-zinc-400">پلان 2D</button>
          <button (click)="viewMode.set('3d')" [class.bg-zinc-700]="viewMode() === '3d'" [class.text-white]="viewMode() === '3d'" class="px-3 py-1 text-xs rounded transition-colors text-zinc-400">سه بعدی</button>
          <button (click)="viewMode.set('building-3d')" [class.bg-zinc-700]="viewMode() === 'building-3d'" [class.text-white]="viewMode() === 'building-3d'" class="px-3 py-1 text-xs rounded transition-colors text-zinc-400">حجم کلی</button>
        </div>
      </div>

      <div class="flex-1 relative overflow-hidden bg-[#101012]">
        @if (viewMode() === '2d') {
          <div class="w-full h-full flex items-center justify-center p-10">
             @if (currentFloorPlan(); as plan) {
              <div class="relative bg-zinc-800 shadow-2xl border border-zinc-700 transition-all duration-500" [style.aspect-ratio]="landWidth() / landDepth()" [style.width]="'min(100%, 600px)'">
                 <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px;"></div>
                 @for (room of plan.rooms; track room.name) {
                  <div [class]="'absolute flex flex-col items-center justify-center text-center p-1 border transition-all room-type-' + room.type"
                      [style.left.%]="room.layout.x"
                      [style.top.%]="room.layout.y"
                      [style.width.%]="room.layout.width"
                      [style.height.%]="room.layout.height">
                      <span class="text-[10px] font-bold text-zinc-100">{{ room.name }}</span>
                      <span class="text-[8px] text-zinc-400 font-mono mt-0.5">{{ room.area }}m²</span>
                  </div>
                 }
              </div>
             }
          </div>
        } @else {
          <div class="w-full h-full">
            <app-three-d-view 
              [plan]="currentFloorPlan() || undefined" 
              [result]="analysisResult()"
              [viewType]="viewMode() === 'building-3d' ? 'building' : 'single'"
              [landWidth]="landWidth()" 
              [landDepth]="landDepth()"
              [neighborWestFloors]="neighborWestFloors()"
              [neighborEastFloors]="neighborEastFloors()"
              [customPolygon]="inputType() === 'draw' ? polygonPoints() : undefined">
            </app-three-d-view>
          </div>
        }
      </div>

    } @else {
      <!-- EMPTY STATE / LOADING -->
      <div class="flex-1 flex flex-col items-center justify-center text-zinc-600 p-8">
        @if (step() === 'loading') {
           <div class="flex flex-col items-center gap-4">
             <div class="relative">
               <div class="w-16 h-16 border-2 border-zinc-800 border-t-zinc-200 rounded-full animate-spin"></div>
               <div class="absolute inset-0 flex items-center justify-center">
                 <div class="w-2 h-2 bg-zinc-200 rounded-full animate-pulse"></div>
               </div>
             </div>
             <p class="text-sm animate-pulse font-mono">{{ currentLoadingMessage() }}</p>
           </div>
        } @else {
           @if (inputType() === 'numeric') {
            <div class="w-24 h-24 bg-zinc-900 rounded-2xl flex items-center justify-center mb-6 border border-zinc-800 shadow-inner">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-zinc-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            </div>
            <h3 class="text-lg font-medium text-zinc-400 mb-2">خوش آمدید</h3>
            <p class="text-sm max-w-md text-center">مشخصات زمین را وارد کنید یا از حالت "ترسیم زمین" استفاده کنید.</p>
           }
        }
      </div>
    }
  </main>
</div>
